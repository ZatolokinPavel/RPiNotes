# Пользователи
Как настраивать пользователя pi я всё ещё не знаю.  
А здесь будет описано как добавить пользователя okfilm для только чтобы можно было загружать файлы на сайт в раздел "файлообменник" и не натупить больше нигде.  

### Полезные команды
`$ cat /etc/passwd` - просмотр списка всех пользователей в формате account:password:UID:GID:GECOS:directory:shell  
`$ w` или `$ who` - показать какие пользователи сейчас активны и что выполняют  
`$ lastlog` - дата последнего входа для каждого пользователя  

### Добавление пользователя okfilm для загрузки файлов  
https://www.dmosk.ru/miniinstruktions.php?mini=ssh-chroot  
http://forum.ispsystem.ru/showthread.php?3528-Доступ-по-SSH-в-chroot-окружение/page4  

0. На этом этапе у нас уже должна быть готова папка для загрузки файлов.  
Для этого был [создан отдельный раздел](Disk%20partitioning.md) на карте памяти и [смонтирован](Монтирование%20диска%20или%20флешки.md) в папку `/mnt/okdisk`.  
Все файлы из `/srv/shared-global/` перемещаем на этот отдельный раздел и ставим вместо папки `/srv/shared-global/` символьную ссылку на папку `/mnt/okdisk/shared-global/`. Таким образом у нас весь файлообменник будет храниться на отдельном разделе карты памяти.  
1. Собственно, добавляем пользователя okfilm:  
`$ sudo adduser okfilm`  
`$ sudo passwd okfilm` и задаём ему пароль.  
2. Создаём пользователю `okfilm` сертификаты, добавляем публичный отдельной строкой в `~/.ssh/authorized_keys`, копируем на комп оба и подготавливаем для PuTTY. Всё это описано [здесь](SSH.md#сертификаты-для-ssh).  
3. Добавляем пользователя в список разрешенных для доступа по ssh.  
   Для этого в файле `/etc/ssh/sshd_config` дописываем его в параметр `AllowUsers`  
4. Запрещаем пользователю okfilm просматривать любые каталоги кроме файлообменника. Для этого в файле `/etc/ssh/sshd_config` нужно закомментировать одну строчку и добавить вместо неё вторую:  
   `#Subsystem sftp /usr/lib/openssh/sftp-server`  
   `Subsystem sftp internal-sftp -f AUTH -l VERBOSE`  
   Тем самым мы включаем встроенный sftp сервер вместо того, который внешний. Внешний уже устарел, а встроенный лучше практически во всех отношениях.  
   И в самый конец нужно добавить следующие строки:  
   ```
   Match user okfilm
       ChrootDirectory /mnt/okdisk
       ForceCommand internal-sftp
       AllowTcpForwarding no
       X11Forwarding no
   ```
   Важно чтобы все папки в пути `ChrootDirectory /mnt/okdisk` имели права 755, и их владельцем был root. А уж внутри можно создавать любые папки с любыми правами.  
5. Перезапускам sshd `$ sudo service ssh restart`  
6. На флешке создаём папку `/mnt/okusb/shared-global/` в которой будут лежать файлы файлообменника. Присваеваем ей права 777, а владельцем делаем пользователя okfilm.
7. Под обычным пользователем переходим в папку `/srv/` и создаём символьную ссылку на папку файлообменника:  
   `ln -s /mnt/okusb/shared-global/ /srv/shared-global`

### Добавление пользователя devops для автоматического деплоя проектов  
1. Собственно, добавляем пользователя devops:  
   `$ sudo adduser devops`  
   `$ sudo passwd devops` - задаём ему пароль
   `sudo usermod -aG sudo devops` - добавляем его в группу sudoers.  
3. Создаём пользователю `devops` сертификаты, добавляем публичный отдельной строкой в `~/.ssh/authorized_keys`, копируем на комп оба и добавляем приватный в секреты на гитхабе.  
   Вообще, сертификаты уже созданы, но если что, то создание описано [здесь](SSH.md#сертификаты-для-ssh).  
4. Добавляем пользователя в список разрешенных для доступа по ssh.  
Для этого в файле `/etc/ssh/sshd_config` дописываем его в параметр `AllowUsers`  
5. Запрещаем пользователю devops просматривать любые каталоги кроме требуемого для деплоя. Для этого в файле `/etc/ssh/sshd_config` включаем встроенный sftp сервер вместо того, который внешний:  
   `#Subsystem sftp /usr/lib/openssh/sftp-server`  
   `Subsystem sftp internal-sftp -f AUTH -l VERBOSE`  
   И в самый конец нужно добавить следующие строки:  
   ```
   Match user devops
       AllowTcpForwarding no
       X11Forwarding no
   ```
6. Перезапускам sshd `$ sudo service ssh restart`
7. Разрешаем пользователю devops выполнять команды sudo без пароля:  
   `sudo cp /etc/sudoers.d/010_pi-nopasswd /etc/sudoers.d/010_devops-nopasswd`  
   и в этом файле заменить имя пользователя, чтобы получилось `devops ALL=(ALL) NOPASSWD: ALL`. Права у файла 0440, так что временно придётся выставить 0640  

### Изменение данных пользователя  
`chfn [параметры] [ПОЛЬЗОВАТЕЛЬ]` - поменять параметры GECOS для пользователя  
