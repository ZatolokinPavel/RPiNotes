# Монтирование дополнительного раздела на карте памяти

_Тут кратко те же инструкции, что описаны ниже для флешки, но с поправкой на диск и без описания и ссылок на источники._  

Задумка такая, что системный раздел на карте памяти занимает 16GB, а всё остальное выделено в отдельный раздел `userdisk`. Это позволит запосывать туда любые данные и не беспокоиться что, в случае полного заполнения диска, система начнёт глючить. Раньше этот диск использовался под файлообменник "OkFILM диск", но сейчас файлообменник вынесен на отдельную USB флешку. Впрочем, если флешка отсутствует, то для файлообменника будет использовано место на разделе userdisk.  

Итак, сначала создаём папку `/mnt/userdisk/`  
Затем, создаём файл `/etc/systemd/system/mnt-userdisk.mount`  
```
[Unit]
Description=User data disk (to avoid overfill the system disk)
[Mount]
What=/dev/mmcblk0p3
Where=/mnt/userdisk
Type=ext4
Options=defaults,noatime
[Install]
WantedBy=multi-user.target
```
Теперь этот файл нужно подключить и сразу же смонтировать:  
`sudo systemctl daemon-reload`  
`sudo systemctl enable --now mnt-userdisk.mount`  
Всё готово.  
Юнит автомонтирования не используем, так как это встроенный диск, он не может отсутствовать.  

# Монтирование флешки, подключённой по USB

### Поиск флешки как устройства
Сначала просматриваем все подключенные устройства командой  
`sudo fdisk -l`  
В результатах этой команды ищем что-то похожее на флешку. В моём случае основная карта памяти Raspberry Pi называлась `/dev/mmcblk0` а флешка, подключенная через USB попала на устройство `/dev/sda`. В дальнейшем чтобы посмотреть информацию только по флешке можно использовать такую команду:  
`sudo fdisk -l /dev/sda`

### Пересоздание разделов
Если это новая флешка, не готовая к работе в системе!  
Вызываем диалог управления разделами на устройстве /dev/sda  
`sudo fdisk /dev/sda`
> Это опасная операция! В результате будут удалены все данные на флешке.

Тут кратко команды:
```
   a   переключение флага загрузки  
   b   редактирование метки диска bsd  
   c   переключение флага dos-совместимости  
   d   удаление раздела  
   l   список известных типов файловых систем  
   m   вывод этого меню  
   n   добавление нового раздела  
   o   создание новой пустой таблицы разделов DOS  
   p   вывод таблицы разделов  
   q   выход без сохранения изменений  
   s   создание новой чистой метки диска Sun  
   t   изменение id системы раздела  
   u   изменение единиц измерения экрана/содержимого  
   v   проверка таблицы разделов  
   w   запись таблицы разделов на диск и выход  
   x   дополнительная функциональность (только для экспертов)
```
Нам нужны будут команды d, n (внутри p), w. Все параметры можно оставлять по умолчанию.  
Подробнее можно прочитать тут: http://dmitrykhn.homedns.org/wp/2009/12/formatirovanie-fleshki-v-linux/

### Форматирование
Если флешка ещё не была подготовлена!  
Форматируем в ext4 (не могу сказать почему) с меткой диска 'okdisk' устройство /dev/sda1  
`sudo mkfs.ext4 -L okdisk /dev/sda1`

### Монтирование единоразовое
До первой перезагрузки.  
Создать папку `/mnt/okdisk/` и смонтировать флешку туда командой  
`sudo mount /dev/sda1 /mnt/okdisk/`  

Размонтировать потом можно будет командой  
`sudo umount /dev/sda1`

Если файловая система позволяет, после монтирования можно будет поменять права доступа к флешке  
`sudo chown -R pi:pi /mnt/okdisk/`

Ну и может что ещё интересное про монтирование можно прочитать в этой статье: https://itshaman.ru/articles/3/mount

### Автомонтирование
Для этого будем использовать юниты Systemd. [Тыц](https://habr.com/ru/post/331240/), [тыц](https://dev.to/adarshkkumar/mount-a-volume-using-systemd-1h2f), [тыц](http://yar4e-it.blogspot.com/2014/09/systemd-mount-cifs.html) и [тыц](https://habr.com/ru/company/southbridge/blog/255845/).  
Юниты монтирования имеют расширение `.mount`. Системные юниты находятся в директории `/run/systemd/generator/`, а пользовательские юниты лучше кидать в `/etc/systemd/system/`.  
> Mount units must be named after the mount point directories they control. Example: the mount point /home/lennart must be configured in a unit file home-lennart.mount.

Итак, создаём файл `/etc/systemd/system/mnt-okdisk.mount`  
```
[Unit]
Description=OkFILM global share
[Mount]
What=/dev/disk/by-uuid/986769cb-0803-44f7-8819-8dd0ab0b5ee7
Where=/mnt/okdisk
Type=ext4
Options=defaults,noatime,nofail
DirectoryMode=0755
TimeoutSec=5
[Install]
WantedBy=multi-user.target
```
и подключаем его:  
`sudo systemctl enable --now mnt-okdisk.mount`  
Всё.  
Что в итоге получили? Флешка монтируется после перезагрузки. Если флешки нет, то система загружается как обычно, не виснет. Если потом флешку вставить, то автомонтирования не произойдёт, нужна перезагрузка. Если флешки нет, а кто-то на неё полезет, то он увидит содержимое каталога `/mnt/okdisk` на системной sd-карте. Если флешка была смонтирована, а её вынули, то при попытке доступа будет ошибка i/o.  
И ещё, опция TimeoutSec не работает без флага nofail.  

<details>
   <summary>Automount:</summary>
   
   Для автомонтирования в момент обращения к флешке необходимо создать файл автомонтирования `/etc/systemd/system/mnt-okdisk.automount`  
   ```
   [Unit]
   Description=OkFILM global share
   [Automount]
   Where=/mnt/okdisk
   [Install]
   WantedBy=multi-user.target
   ```
   и подключить его  
   `sudo systemctl enable mnt-okdisk.automount`  
   вместо команды `sudo systemctl enable --now mnt-okdisk.mount`  
   Но automount не очень для серверных каталогов. Если флешка не вставлена в usb, то попытка монтирования будет происходить каждый раз, когда кто-то будет запрашивать файлы. Кроме того, наверное не удастся использовать хранилище на системной sd-карте в случае отсутствия флешки.

   ---
</details>

<details>
   <summary>Старый способ</summary>

   http://tftf.ru/stati/linux/avtomontirovanie_diskov_pri_zapuske_linux_(k)ubuntu__podklyuchenie_diskov/  
   Командой `sudo fdisk -l` можем посмотреть размер нашей флешки. Но и всё.  
   Командой `blkid` смотрим UUID и PARTUUID флешки. Флешка, скорее всего, это устройство `/dev/sda1`.  
   Теперь в файле `/etc/fstab` в самый конец дописываем такую строчку:  
   `PARTUUID=494659b8-01  /mnt/okusb      ext4    defaults          0       0`  
   где идёт PARTUUID флешки, затем точка монтирования, потом файловая система, опции и два ненужных мне флага.  
   > Важно! После такой операции без флешки система не загрузится больше.  
</details>

# Проверка UUID
Внешние флешки монтирую как `What=/dev/disk/by-uuid/986769cb-0803-44f7-8819-8dd0ab0b5ee7`. Это позволяет монтировать одну и ту же флешку в одинаковый каталог на любом RaspberryPi. Но это указан UUID файловой системы. Если флешку отформатировать, или вообще сменить, то он изменится. Зато если флешка уже подготовлена и содержит мои данные, то UUID файловой системы всегда будет неизменный. До первого форматирования.  

В общем, так как этот UUID прописан в скрипте настройки, то нужно командой `blkid` проверить что UUID в файлах  
`/etc/systemd/system/mnt-okdisk.mount`  
`/etc/systemd/system/mnt-photodisk.mount`  
совпадает с реальным UUID файловой системы на флешках.
